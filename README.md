
## 单点登录

单点登录希望能够保存住「已经登录」的状态，使得用户在一定时间内能够直接访问已经登录后的网站而无需再次登录。

HTTP协议是一种无状态的协议，因此为了实现单点登录，还需要一些额外方法。

### Cookie

用户登录之后，由服务器生成用户认证信息保存到Cookie当中，返回给客户端。客户端在请求访问其他系统时，可以通过验证 Cookie 中的信息，实现单点登录。

Cookie 实现单点登录的特点可以从存储、运输两个方面考虑：

1. 存储方式：单点登录所需要的用户信息存储在 Cookie 中
2. 存储大小：Cookie 在浏览器中的存储有大小限制，4KB，只能存储有限的用户信息
3. 传输方式：用户信息直接存在 Token 中，跟 HTTP 请求一起带过去。
4. 传输安全性：Cookie 是不安全的，例如 Cookie 很容易受到**跨站请求伪造 CSRF** 攻击
5. 跨域传输：Cookie 受同源策略的限制，也就是说，只有在同源（协议、域名、端口都相同）的服务当中使用，否则需要重新配置跨域策略。

> 什么是跨站请求伪造？
> 
> 由于我们提到了 Cookie 是跟着请求自动发送的，这意味着黑客可以在自己的网站放一个恶意链接（如一个银行转账请求），用户误点此伪造的请求后，用户认证信息通过 Cookie 直接到达银行网站，通过校验，实现了恶意攻击。
> 
> 可以看到，CSRF 攻击的根本原因在于，黑客不需要感知到 Cookie 的认证信息即可伪造一个请求。

### Token

Token 认证可以看成对 Cookie 的改进。在 Cookie 认证当中，用户的认证信息存放在 Cookie，而 Token 认证是服务端依据用户认证信息生成一个加密的字符串（Token），显式地交还给客户端。

同样的，在请求认证时，用户需要显式地在请求中带上 Token，由服务端完成验证的过程。服务端验证可以有以下两种策略：

1. 基于加密解密的认证（JWT）：服务端拿到加密后的 Token，进行解密（对称/非对称），还原用户认证信息（用户id、过期时间等）从而确认用户是否已经登录。对于分布式的多系统来说，多系统需要约定好相同的解密方法。
2. 基于 Redis 的认证：在 Redis 中存放 Token - 认证信息 的 pair，服务端拿到 Token 后，请求另外的 Redis 服务，看此 token key 是否存在/过期，并通过 key 获取对应的认证信息。对于多系统，确保连接到同一个 Redis 服务即可。

两种认证策略比较：

1. 时耗：加解密是比较耗时的（尤其是非对称加密），而 Redis 可以用更简单的 token（无需加密），且查一次很快
2. 安全性：加解密虽然安全，但是一旦密钥泄露，系统就寄了。Redis 依赖的是局域内的 Redis 服务，更安全。
3. 维护性：加解密的多系统认证依赖于共识密钥，一旦密钥变动就不好维护了。Redis 没有此问题。
4. 稳定性：加解密认证只依赖服务端本身，而 Redis 认证依赖 Redis，一旦 Redis 寄了，整个认证服务就寄了。

> 为什么非对称加密比对称加密更慢？
> 
> 主要在于计算复杂度上，非对称加密算法（RSA、ECC）等通常基于一些难解的数学问题，如大数因子分解、离散对数问题，并且有大数的乘除模法，这些问题涉及的复杂度很高，因此计算比较慢。
> 而对称加密的计算少（AES-128只有10轮），计算简单（都是位运算），因此计算很快。

> RSA 加密的过程是怎么样的？
> 1. 密钥生成：选取两个大质数 p，q。生成 n = p * q。再生成 e，要求 e \< phi(n)，且与之互质。再生成 d，要求 e * d = 1 mod phi(n). 于是 pub = (n, e), prv = (n, d)。
> 2. 加密：C = M^e mod n
> 3. 解密：M = C^d mod n

Token 特点及与 Cookie 比较：

基本上来说，Token 解决了 Cookie 的缺点。还是从存储、运输的角度的考虑：

1. 存储方式：加密的用户信息本身，或者是用户信息的 key 存储在 Token 中。
2. 存储大小：Token 没有大小的限制。而 Cookie 最多 4KB。
3. 传输方式：Token 需要显式地写在请求体当中。
4. 传输安全性：Token 可以避免 CSRF 攻击，因此黑客无法获得 Token。而 Cookie 更容易被攻击。
5. 传输域：Token 不受同源策略的限制，可以跨域传输。而 Cookie 需要配置传输策略。

### 双token登录

双 Token 登录在**安全**和**体验**之间取了一个平衡。

单 Token（访问Token）为了实现安全性，会设置比较短的过期时间。这意味着用户需要频繁地登录获取新的访问 Token，降低了用户的体验。如果延长过期时间，那么访问令牌泄露的后果又很严重。

双 Token 使用两个 Token，一个是访问 Token（Access Token, AT）, 一个是刷新 Token（Refresh Token, RT）。

访问 Token 的过期时间很短（30 min），而刷新 Token 的过期时间比较长（7 days）。

用户通过访问 token 和刷新 token 进行认证。如果访问 token 过期了，可以通过 过期访问token + 刷新 token 申请到新的访问 token。

双 token 的特点：

1. 安全性：尽管安全性不如短AT，比长AT更安全。因为生成新的过期信息需要 过期AT + RT，两个同时泄露才行。
2. 体验：使用 RT 之后，登录周期大大延长，提高了用户的体验。

-- 通过双 Token 机制 + 非对称加密认证实现单点登录


login时怎么加密密码:

> raw -enc-> web
> 
> raw -md5-> db

UserSupport -- ServletRequestAttributes?


@autowired & @resource diff？

register: user, userInfo, userCoin

分页查询实现，优化？